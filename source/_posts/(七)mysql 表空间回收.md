---
title: (七)mysql 表空间回收
date: 2022-11-05 13:54:46
index_img: /img/mysql.png
categories:
  - mysql
tags:
  - 数据库
---

### 表空间的存储设置

首先有个设置 `innodb_file_per_table` 表示是否把表数据存储为单个文件,否则的话就放在共享表空间里

明确一点,单独存放为一个文件更好,因为这样更便于管理; 而且 `drop` 命令执行时会删除对应的表文件,如果放在共享空间里, `drop` 命令不会回收表空间

### delete 语句为何不会回收表空间

**可以结合前面讲的索引复习**, 都知道 mysql 的索引是用 `B+` 树实现的,由于 `B+` 树也是一种自平衡的树,所以在对某些索引进行删除或者插入的时候,由于单个节点存储的索引有限,势必会导致单个节点的分裂或者多个节点的重组

![img.png](https://tva1.sinaimg.cn/large/008vK57jgy1h7uatmc03pj30ex0bjjt2.jpg)

假设需要删除 `R4` 这条记录,此时并不会实际操作磁盘,而是把页里面的 `R4` 标记为删除,这是一种 **软删除** 或者叫做 **逻辑删除**

后面如果插入 `300` 到 `600` 的记录,是完全可以继续复用这个位置的

同理当插入一条记录的时候,如果此时页里面已经放满了数据,就会导致当前节点分裂为多个节点,将原先的页按照一定规则重新放到多个节点上

这里需要注意一点:

记录的删除仅仅是在页里面将当前数据的位置标记为可复用,而页的删除则是将里面所有的数据标记为可复用

![img_1.png](https://tva1.sinaimg.cn/large/008vK57jgy1h7uattc0hej30oc0fjdk8.jpg)

例如插入 `550` 的记录,此时由于页里面已经放满了索引此时需要把原来的页 A 一部分索引数据拆分到一个新的页 B 里面去;这里的拆分和重组由 `B+` 树的插入和删除性质计算的到

此时会导致原来完整的 A 出现了 **数据空洞**, 同时新页 B 也产生了 **数据空洞** ; 当一张表经过大量的增删改操作之后,很有可能存在不少的 **数据空洞** 

总结来说,`delete` 语句仅仅是将页里面的记录位置标记为可以复用,而不是真正的删除页释放空间; 所以执行 `delete` 语句是无法回收表空间的

### 重建表解决表空间空洞的问题

利用 AB 表的思想,创建一张结构与 A 表相同的 B 表,依次扫描 A 表并顺序插入在 B 表当中, 这样处理过后 B 表的主键就是紧凑没有数据空洞的,数据页的利用率也更高; 操作完成后把流量切到 B 表,然后再删除 A 表即可

或者直接用 myslq 提供的指令 `alter table A engin = InnoDB` 进行表的重建

重建过程当中,如果有新数据写入旧表的话,是不会同步到新表的,此时会导致数据丢失,更新也一样; 所以整个重建过程,必须保证旧表处于只读状态

如果说保持表 A 的只读状态,那么此时的 `DDL` 操作就不是 `Online` 的

在 mysql 5.6 开始引入 `Online DDL` ,即重建过程当中,也支持对表 A 的写操作

基本原理如下:

1. 扫描表 A 的所有数据页,重新生成对应的 B+ 树,存储到临时文件当中
2. 生成临时文件的过程中,如果有对表 A 的写操作,则记录在 `row log` 的日志文件当中
3. 临时文件生成后,与 `row log` 的记录进行 `merge` 操作,得到最终的临时文件
4. 将最终的临时文件应用到表 A 上

![img_2.png](https://tva1.sinaimg.cn/large/008vK57jgy1h7uatzz998j30o70ehdmc.jpg)

前面说过表级锁有表锁和 `MDL` 锁,其中 `MDL` 写锁就是为了防止在查询过程当中表结构发生变化

而此时的 `DDL` 重建表操作就会申请到 `MDL` 写锁,按照其定义,后续对表 A 的读写请求应该都被阻塞了才对

其实实际重建表的过程当中,这里的 `MDL` 写锁在 `alter` 语句开始执行后,真正拷贝数据之前就已经退化成 `MDL` 读锁了,这样做重建的时候不会阻塞其他的增删改查操作

此时也不能直接释放 `MDL` 锁,这样是为了保护不受其他后面的 `DDL` 影响

在整个重建过程中,最耗时的是数据拷贝到临时表的过程,这里退化成读锁也不会阻塞其他正常请求,而到了真正需要拷贝数据的时候,相对于整个过程, `MDL` 写锁的持有过程相对来说并不长,可以近似认为是 `Online` 的

