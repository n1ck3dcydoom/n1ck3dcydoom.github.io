---
title: (四)redis 哨兵模式
date: 2022-11-11 09:12:35
index_img: /img/redis.png
categories:
  - redis
tags:
  - redis
---

### 读写分离场景下主库宕机怎么办

读写分离场景下,只有主库才能提供写服务; 如果主库发生故障宕机,此时所有的写请求将不可用,而且从库的主从同步也会断开导致读请求可能产生数据不一致问题

![img.png](https://tva1.sinaimg.cn/large/008vK57jgy1h81h2ajpchj30iz0cqjto.jpg)

此时需要将一个从库提升为新的主库来提供写服务,其他从库继续从这个新的主库上进行主从同步; 这个过程涉及到 3 个问题

1. 主库是否真的挂了
2. 选哪个从库作为主库
3. 怎么把新主库的信息告知给其他从库和客户端

redis 提供了 `哨兵` 机制实现主库的选举和自动切换以及故障转移

#### 哨兵的基本流程

哨兵的本质就是一个运行在特殊模式下的 redis 进程; 主从库 redis 实例运行的时候,哨兵进程也随之运行; 主要负责三个任务

1. 监控

当哨兵和其他主从库正常运行时,哨兵需要周期性地给其他所有库发送心跳检测 `ping` 命令,用于检测对应 redis 实例是否在线运行

如果在规定时间内哨兵没有收到对应实例回应的 `pong` 命令,则哨兵此时会把这个实例标记为 `下线状态`

同理,如果是主库在规定时间内没有回复 `pong` 命令,此时哨兵会认为主库下线,就会启动主从切换的流程

2. 选主

当启动主从切换流程后,哨兵接下来的任务就是在众多的从库当中选择一个新的主库

3. 通知

当新的主库产生后,哨兵需要把新的主库的实例信息发送给其他所有从库,让从库与新主库之间建立联系继续进行主从同步; 同时还要把新主库的信息和已经下线的老主库信息发送给客户端,让客户端的写请求进入新的主库

需要注意的是,在第一步监控过程当中,将一个 redis 实例标记为 `下线状态` 这里其实是有两种不同的状态,分为 `主观下线` 和 `客观下线`

#### 主观下线

哨兵在监控过程当中,向每个实例发送 `ping` 命令心跳包,用于检测实例是否处于正常在线状态; 如果一个实例长时间没有回复 `pong` 命令,或者因为网络延迟导致 `pong` 命令超时,此时哨兵会 `主观` 地认为这个实例不可用,从而将其标记为 `主观下线` 状态

1. 如果是一个从库被标记为 `主观下线` 此时影响还不算太大,因为其他主从库仍然能够提供服务,整个集群对外的服务不会中断
2. 如果是一个主库被标记为 `主观下线` 这个时候问题就来了,因为主从切换是一个很复杂的过程,进行一次主从切换很可能导致服务发生中断; 这个时候能简单地认为主库真的挂掉了吗

首先哨兵也可能存在误判,主库正常提供服务,如果是主库和哨兵之间的网络通信出现了一些波动,导致网络延迟哨兵没有收到主库的心跳包,这个时候哨兵就误以为主库故障了

亦或者说主库正在面临较大的压力,处理大量的请求导致回复一条 `pong` 命令来不及,这个时候也不能简单地认为主库故障了,很有可能是人家忙不过来而已

#### 客观下线

为了避免单个哨兵节点将主库标记为 `主观下线` 从而导致频繁的主从切换,实际场景下的哨兵通常也是采用集群部署的方式

即多个哨兵节点构成一个哨兵集群,这个哨兵集群同时负责监控所有 redis 实例,以及共同决定选主和主从切换发生的时机,减少单机哨兵节点的误判

当哨兵集群内超过一定数量的哨兵都认为主库已经发生故障,这个时候的主库会被标记为 `客观下线`

![img_1.png](https://tva1.sinaimg.cn/large/008vK57jgy1h81h2hbnmfj30j606z0uh.jpg)

如上图所示,哨兵 2 认为主库挂掉了,但此时哨兵 1 和 3 都认为主库健康,少数服从多数原则此时主库最终被认定为健康状态

而当哨兵 1 和 2 都认为主库挂掉了,此时哨兵 3 认为主库健康,同样也是少数服从多数,此时主库被最终认定为 `客观下线`

这个少数服从多数最简单的判断公式就是: 当有 N 个哨兵节点时,如果有 `N/2 + 1` 个哨兵节点同时认为主库 `主观下线` 此时就最终判定为主库 `客观下线` 从而进行新的选主和主从切换

### 哨兵模式的选主过程

一旦主库被认定为 `客观下线` 接下来就要在众多的从库当中,选出一个 `最合适` 的新主库; 这个过程可以简化为 `筛选+打分`

简单来说,先按照一定的条件,筛选出一批可能的从库; 然后按照一定规则对这些从库打分,最后得分最高的从库被选定为新的从库

![img_2.png](https://tva1.sinaimg.cn/large/008vK57jgy1h81h2m6wyjj30j1091wg5.jpg)

#### 筛选条件

通常来说,主库需要面临更大的压力,如果一个从库本身的配置较低或者网络就不稳定,那么它也不具备成为新主库的条件; 已经下线的从库自然更没法参与选主过程

而且对于网络状态的判断,并不能简单的通过当前可用就认为这个从库的网络一直很好; 还需要判断之前的网络状态; 如果在这之前从库经常和主库发生断连,并且这个断连次数超过了一定配置;那么也认为这个从库的网络状态并不好

可以通过配置主从库之间的最大连接时间,以及最大断连次数来判断一个从库的综合网络状况

#### 从库打分

在完成筛选过程后,就需要对通过的从库按照一定的规则进行打分,具体的打分规则如下:

1. 第一轮: 检查从库有没有配置过优先级,优先级更高的从库得分高; 优先级可以通过配置手动指定,通常把一些配置更好,网络质量更佳的从库配置更高的优先级; 这样当发生主从切换的时候,这些优质的从库更有可能成为新的主库

2. 第二轮: 如果所有从库的优先级都一样; 哨兵就需要判断所有从库与旧主库的同步进度, 同步进度越近的从库得分越高

对于第二轮打分,如何判断主从之间的同步进度:

之前有说过 redis 在做主从同步的时候,主库上维护了一个 `replicaiton buffer` 和 `replication backlog`, 其中 `backlog` 是一个环形数组,而且主库和从库分别在 `backlog` 上记录主库的最新写入位置和从库的最新读取位置; 这两个位置中间的差距就称为主从同步的偏移量 `offset`

此时就通过这个 `offset` 的值,取出所有从库的 `offset` 判断哪个从库有最小的 `offset` 值,这样就可以认为这个从库之前与旧主库的同步进度更接近,如果把它选为新主库的话,数据不一致的可能性更低

![img_4.png](https://tva1.sinaimg.cn/large/008vK57jgy1h81h2qqt3gj30j405q759.jpg)

可以看到此时的旧主库写入位置为 `1000`

从库 1 的读入位置为 `950` 此时 `offset=50`; 从库 2 的读入位置为 `950` 此时 `offset=50`; 从库 3 的读入位置为 `900` 此时 `offset=100`

这样从库 3 的同步进度明显落后于从库 1 和 2,在第二轮打分中,从库 3 被淘汰掉

3. 第三轮: 实例 id 号小的从库得分更高

在经历了网络质量检查,主从同步进度检查两轮打分之后,如果还剩下多个从库,此时就选取里面实例 id 号最小的从库成为新的主库

至此,整个选主过程就完成,新的主库产生

#### 通知其他从库和客户端有新的主库产生

完成选主之后,的主从切换,称为 `故障转移`

### pubsub 消息通知机制

多个哨兵之间如何完成互相发现,哨兵之间如何进行通信,这依赖于 redis 提供的 `pub/sub` 消息机制

所有哨兵都订阅主库上的同一个频道 `_sentinel__:hello` ,这样当有一个哨兵往这个频道里发送消息时,其他哨兵都能通过订阅这个频道接收到对应的消息

(感觉可以把这个频道理解为消息队列的 `topic` 主题)

![img_5.png](https://tva1.sinaimg.cn/large/008vK57jgy1h81h2v5vogj30j10a7wgc.jpg)

哨兵 1 往频道里发送自己的 ip 地址和端口号,哨兵 2 和 3 接收到消息后就能与哨兵 1 建立连接,同理哨兵 2 和 3 之间也是通过这种方式建立连接

哨兵除了在互相之间建立连接,还需要和主库从库之间建立连接,这样才能监控主从库的运行状态

哨兵通过向主库发送 `info` 命令,查询主库上的从库列表信息,在得到所有所有从库列表信息之后就可以和从库之间建立连接了

![img_6.png](https://tva1.sinaimg.cn/large/008vK57jgy1h81h2zduqxj30ff09yjt0.jpg)

除了哨兵之间,哨兵和主从库之间建立连接,哨兵还需要和客户端之间建立连接,这样当发生主从切换后,哨兵才能将新主库的地址信息发送给客户端,不然客户端无法感知到主从切换和新主库的存在

对于哨兵来说,其本质就是一个特殊的 redis 实例,只不过哨兵并不对外提供查询和写入的服务而已,所以哨兵自己也可以有消息频道,这样客户端就能够通过订阅哨兵的不同消息频道,接收各种事件,处理对应的业务了

借助于 redis 提供的 `pubsub` 消息机制,主从切换当中最后一个步骤也完成了,此时客户端就能通过订阅的频道,接收到主从切换完成的消息,以及新主库的配置信息,从而跟新主库建立连接进行后续的业务处理

### 主从切换由哪个哨兵发起

对于哨兵集群来说,任何一个哨兵节点都可以发起主从切换,只要它获得了足够的资源

当一个哨兵认为主库 `主观下线` 时,他就会往其他所有哨兵发出一条 `is_master_down_by_addr` 的指令,其他哨兵在接收到这条指令后,就会检测主库之间的状态

如果有其他哨兵也认为主库已经 `主观下线` 则会给第一个认为 `主观下线` 的哨兵回复一条 `Y` 赞成票

如果其他哨兵并不认为主库已经 `主观下线` 则会给第一个认为 `主观下线` 的哨兵回复一条 `N` 反对票

这样,当第一个发起投票的哨兵在接收到其他所有哨兵的回复之后,统计所有的票数,满足两个条件就发起主从切换

1. 得到的赞成票必须超过哨兵节点个数的一半及以上, 也就是说 `赞成票 >= N/2 + 1
2. 得到的赞成票必须超过一个配置的 `quorum` 值

此时的哨兵就会把主库标记为 `客观下线` ,这样这次主从切换就由当前哨兵发起,此时当前哨兵称为 `leader`

整个投票的过程,称为 `leader` 的选举

当一个哨兵开始发起选举投票后,如果还收到了其他哨兵选举投票的申请时,会直接回复 `N` 反对票; 而且对于同一个哨兵,他只能在第一次无条件投出赞成票,之后的所有其他选举请求,都只会投反对票

![img_7.png](https://tva1.sinaimg.cn/large/008vK57jgy1h81h33laxxj30j70cyjuo.jpg)

一个哨兵在发起选举之后,如果没有得到半数以上的赞成票,此时会等待一段时间后,重新发起选举

### 概念阐述

1. 要判断一个主库是否 `客观下线` 必须要认为其 `主观下线` 的哨兵个数超过 `quorum` 值
2. 要发起一次主从切换,必须要完成一次选主过程; 而哨兵要成为 `leader` 必须满足两个条件
   * 得到的赞成票超过哨兵总数的半数以上,即 `赞成票 >= N/2 + `
   * 得到的赞成票大于等于 `quorum` 值

考虑如下场景: 有 5 个哨兵组成的哨兵集群,其中 3 个哨兵发生了故障,配置的 `quorum` 值为 2; 如果此时主库真的发生故障, 主库能否被标记为 `客观下线` ? 整个集群能否发生主从切换

1. 当一个哨兵发现主库 `主观下线` 后发起一次选举投票,首先给自己投一票,再将选举请求发送给其他哨兵
2. 另一个哨兵如果先接收到投票请求,再发现主库故障; 此时会给另一个哨兵投赞成票; 接着发起一次选主投票,由于自己已经投过赞成票了,所以只能给自己投反对票
   * 如果另一个哨兵先发现主库故障,再收到投票请求; 此时会先发起选主投票并给自己投赞成票, 之后接收到另一个哨兵的选举请求时,由于已经给自己投了赞成票,所以只能给另一个哨兵回复反对票
   * 此时两个哨兵都给自己投票,结果是都没能超过半数以上; 此时不会产生 `leader` 也不会发生主从切换
   * 每个哨兵再发起选举后如果没能成为 `leader` 则会等待一段时间后再次发起选举投票
3. 对于 2.1 此时一个哨兵得到了 2 票赞成票大于等于 `quorum` 值了,但是由于一共有 5 个哨兵,没能超过哨兵的一半; 所以也无法成为 `leader`
   * 对于 2.2 更不会有 `leader` 产生

所以对于这种情况: 主库能够被标记为 `客观下线`; 整个集群无法发生主从切换