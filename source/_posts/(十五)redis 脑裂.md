---
title: (十五)redis 脑裂
date: 2022-11-14 09:19:07
index_img: /img/redis.png
categories:
  - redis
tags:
  - redis
---

### 什么是脑裂

当一个集群内部同时存在两个或者两个以上的主节点,这两个节点都能进行请求的读写,这种现象称为 `脑裂` 它看起来就是一个人拥有了两个大脑

### 最可能导致脑裂的原因

在哨兵模式下,如果主节点在一段时间内无法响应哨兵的心跳包,此时哨兵判定主节点 `客观下线` 后随机启动主从切换过程

如果在这个过程当中原来的主节点恢复正常,此时由于主从切换还未完成,仍然有新的请求进入原来的主节点处理

此时的集群看起来就有两个主节点

### 数据丢失后如何判断是不是因为脑裂引起

1. 判断主从同步的延迟

`replication backlog` 里面获取主库的 `master_repl_offer` 和从库的 `slave_repl_offset` 检查这两个值是否相等; 如果说主从同步之间存在一定的延迟,则数据丢失可能是主从同步时,异常宕机引起的

![img.png](https://tva1.sinaimg.cn/large/008vK57jgy1h851p3udiyj30hd0e075l.jpg)

如果说主从同步的进度是相等的,则数据丢失可能是由于脑裂导致,过程如下

![img_1.png](https://tva1.sinaimg.cn/large/008vK57jgy1h851p8ekgvj30hj0d10uw.jpg)

更严重的是当主从切换完成后,哨兵会对之前的老主节点发出 `slaveof` 指令,令其变为从节点与新的主节点进行同步

在主从切换后进行首次全量同步,会清空从节点本地数据库的所有数据,相当于老的主节点在 `脑裂` 期间所接受的写请求数据将会全丢失; 最终导致严重的数据丢失问题

### 如何避免脑裂问题

redis 提供了两个关键参数,控制一个主节点能否继续接受新的请求

1. `min-slaves-to-write`: 一个主节点至少要有 `N` 个从节点与之进行通行时,主节点才能接受客户端的读写请求
2. `min-slaves-max-log`: 主从节点同步时,最长不得超过 `N` 秒的延迟

一旦一个主节点不满足上述的任何一点,此时 redis 就拒绝主节点接受客户端的请求