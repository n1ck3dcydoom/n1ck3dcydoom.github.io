---
title: (十六)redis 数据倾斜和访问倾斜
date: 2022-11-14 22:54:56
index_img: /img/redis.png
categories:
  - redis
tags:
  - redis
---

### 什么是数据倾斜

当 redis 以集群部署时,如果大量数据都被分配到同一个或者集中在少数几个哈希槽里面,就称此时发生了 `数据倾斜`

![img.png](https://tva1.sinaimg.cn/large/008vK57jgy1h85333yalij30f50ce40c.jpg)

### 什么原因会导致数据倾斜发生

1. `bigkey`: 如果某个哈希槽里面有个绝大无比的 `bigkey` ,此时从外部看起来就是这个哈希槽里面的数据量远超过其他哈希槽

而之前说过,访问或者操作一个 `bigkey` 是一件很消耗性能的事,很可能导致 redis 的主线程阻塞在处理 `bigkey` 上,导致 redis 服务不可用

解决方案: 

将 `bigkey` 进行拆分,拆成若干个更小的 `key` 再存放于不同的哈希槽,使数据均匀分布在不同的哈希槽里; 同时业务层在写入一个 `key` 时就要尽量避免将大量数据写入同一个 `key` 当中

2. `Slot` 分配不均匀

在部署 redis 进群时,采用手动指定分配哈希槽的方式; 如果某些个配置较高的节点希望充当主节点使用,此时就可能会给这些节点多分配几个哈希槽

然而实际上的数据和哈希槽的映射关系并不能提前知道; 如果恰好大量数据全部集中在这几个哈希槽里,就会导致数据倾斜

解决方案:

保持部署的节点配置一致,同时使用 redis 默认的均匀分布策略; 或者发生数据倾斜事,手动迁移其中若干个哈希槽到其他节点上

3. `Hash tag` 导致

如果在设置一个哈希 `key` 时,指定了 `Hash tag`,可能导致大量 `key` 有着相同的 `Hash tag` 从而被分配到几个集中的哈希槽上,出现数据倾斜

`Hash tag` 本身的目的是为了解决 redis 集群不支持 `夸实例` 的事务操作或者范围检索的问题

使用 `Hash tag` 能够把不同的 `key` 指定映射到同一个实例上,这样就可以对单个节点进行事务操作或者范围检索

### 什么是访问倾斜

当大量请求集中访问若干热点 `key` 时,这时候这些热点 `key` 所处的哈希槽对应的实例就会有大量请求进入,而其他实例的请求寥寥无几; 这种现象就称为 `访问倾斜`

![img_1.png](https://tva1.sinaimg.cn/large/008vK57jgy1h8533ai6vjj30gf0clac3.jpg)

此时并不是说哈希槽内的 `key` 分配不均匀,而是说热点 `key` 会被大量访问,无论将这些 `key` 迁移到哪个哈希槽,都会导致对应哈希槽的实例面临大量请求

对于只读 `key` 来说,可以将 `value` 复制若干份,并且把备份的 `key` 添加一些随机数,这样通过多个 `key` 保存了同一份 `value` 值

再把这些备份 `key` 都均匀分布到哈希槽里,再把这些哈希槽都均匀分布到实例节点上; 当客户端请求热点 `key` 时,以同样的算法添加随机数,这样就相当于把原来的热点 `key` 均匀分布到若干实例上,避免了单个实例接受大量请求的问题

但是需要注意的是 `热点数据拷贝` 只能解决 `只读` 数据的访问倾斜问题

对于 `读写` 数据,其拷贝会导致严重的数据不一致问题; 此时唯一的办法就是 `增加节点配置`